/*!
 *  Copyright 2017 Pejman Chatrrooz
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
;window.sync={url:undefined,interval:3,requestMethod:"POST",_working:false,_timer:undefined,_services:[],_enabled:false,_st:0,init:function(c,a,d,b){if(a===undefined){a=3}if(b===undefined){b=true}if(d===undefined){d="POST"}sync.url=c;sync.interval=a;sync.requestMethod=d;if(b!==true&&b!==false){return sync._enabled}sync.setEnabled(b);return sync._enabled},registerService:function(a){if(sync._getServicePos(a._dataKey)!==-1){return false}sync._services.push(a);return true},unregisterService:function(a){var b=sync._getServicePos(a);if(b===-1){return false}sync._services.splice(b,1);return true},_getServicePos:function(c){var a=sync._services.length,b;for(b=0;b<a;b++){if(sync._services[b]._dataKey===c){return b}}return -1},getService:function(a){var b=sync._getServicePos(a);if(b===-1){return undefined}return sync._services[b]},setEnabled:function(a){if(sync._enabled===a){return}sync._enabled=a;if(!a&&sync._timer>0){if(sync._ajx){sync._working=false;sync._ajx.abort()}clearTimeout(sync._timer)}if(a&&!sync._working){sync._sync()}},_sync:function(){if(!sync._enabled||sync._working){return}sync._working=true;var b=sync._services.length,c,a,d;var e={};for(c=0;c<b;c++){a=sync._services[c];if(a&&a.getEnabled()&&a._checkforalt()){e[a._dataKey]=null;if((d=a._getData())){e[a._dataKey]=d}}}var g={type:this.requestMethod,data:e,url:this.url,beforeSend:function(){b=sync._services.length;for(var j=0;j<b;j++){var h=sync._services[j];if(h.getEnabled()&&h._checkforalt()&&h.listeners.start){h.listeners.start(h,e[h._dataKey])}}},error:function(k){b=sync._services.length;for(var j=0;j<b;j++){var h=sync._services[j];if(h&&h.getEnabled()&&h._checkforalt()&&h.listeners.failedSync){h.listeners.failedSync(h,k)}}},success:function(l,h,p){var m,j;b=sync._services.length;if(l.hasOwnProperty("_ok")){var n=l._ok;for(m=0;m<b;m++){j=sync._services[m];if(j&&n.hasOwnProperty(j._dataKey)&&j.getEnabled()&&j._checkforalt()&&j.listeners.hasOwnProperty("success")){j.listeners.success(n[j._dataKey],j,h,p)}}}if(l.hasOwnProperty("_er")){var k="responseText",q="status";var o=l._er;for(m=0;m<b;m++){j=sync._services[m];if(j&&o.hasOwnProperty(j._dataKey)&&j.getEnabled()&&j._checkforalt()&&j.listeners.hasOwnProperty("error")){j.listeners.error(j,{responseText:(o[j._dataKey].hasOwnProperty(k)?o[j._dataKey][k]:undefined),status:(o[j._dataKey].hasOwnProperty(q)?o[j._dataKey][q]:undefined)})}}}},complete:function(k){sync._working=false;b=sync._services.length;for(var j=0;j<b;j++){var h=sync._services[j];if(h&&h.getEnabled()&&h._checkforalt()&&h.listeners.complete){h.listeners.complete(h,k)}}if(sync._timer){clearTimeout(sync._timer)}sync._timer=setTimeout(function(){sync._sync()},sync.interval*1000);sync._st++}};try{if(Object.keys(e).length===0){g.complete(null)}else{sync._ajx=$.ajax(g)}}catch(f){sync._ajx=$.ajax(g)}},Service:function(b,a){this._dataKey=b;this._alt=0;this.listeners={};this._enabled=a!==false}};sync.Service.prototype={_dataKey:undefined,getDataKey:function(){return this._dataKey},setEnabled:function(a){this._enabled=a;return this},getEnabled:function(){return this._enabled},setDataEmitter:function(a){this._dataEmitter=a;return this},setListeners:function(a){this.listeners=a;return this},_getData:function(){if(!this._dataEmitter){return null}return this._dataEmitter()},register:function(){sync.registerService(this);return this},unRegister:function(){sync.unregisterService(this._dataKey);return this},setAlternative:function(a){this._alt=a;return this},_checkforalt:function(){return this._alt===0||sync._st%this._alt===0}};